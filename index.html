<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω S·ªï Ti·∫øt Ki·ªám</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-6xl bg-white shadow-md rounded-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-6">üí∞ Qu·∫£n l√Ω S·ªï Ti·∫øt Ki·ªám</h1>

    <!-- N√∫t m·ªü pop-up -->
    <div class="mb-6">
      <button onclick="openPopup()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">T·∫°o S·ªï M·ªõi</button>
    </div>

    <!-- Pop-up th√™m/s·ª≠a s·ªï -->
    <div id="popup" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
        <h2 id="popupTitle" class="text-lg font-semibold mb-4">Th√™m S·ªï Ti·∫øt Ki·ªám</h2>
        <div class="grid grid-cols-1 gap-4">
          <input id="accountName" type="text" placeholder="T√™n t√†i kho·∫£n" class="border p-2 rounded" required>
          <input id="amount" type="number" placeholder="S·ªë ti·ªÅn g·ª≠i (VND)" class="border p-2 rounded" required>
          <input id="bank" type="text" placeholder="Ng√¢n h√†ng" class="border p-2 rounded" required>
          <input id="startDate" type="date" class="border p-2 rounded" required>
          <select id="term" class="border p-2 rounded" required>
            <option value="" disabled selected>Ch·ªçn k·ª≥ h·∫°n (th√°ng)</option>
            <option value="1">1 th√°ng</option>
            <option value="3">3 th√°ng</option>
            <option value="6">6 th√°ng</option>
            <option value="12">12 th√°ng</option>
          </select>
          <input id="interestRate" type="number" step="0.1" placeholder="L√£i su·∫•t (%/nƒÉm)" class="border p-2 rounded" required>
          <select id="interestType" class="border p-2 rounded" required>
            <option value="" disabled selected>H√¨nh th·ª©c tr·∫£ l√£i</option>
            <option value="start">ƒê·∫ßu k·ª≥</option>
            <option value="end">Cu·ªëi k·ª≥</option>
          </select>
          <select id="renewalType" class="border p-2 rounded" required>
            <option value="" disabled selected>Khi ƒë·∫øn h·∫°n</option>
            <option value="principal">T√°i t·ª•c g·ªëc</option>
            <option value="principalAndInterest">T√°i t·ª•c g·ªëc v√† l√£i</option>
          </select>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
          <button id="saveButton" onclick="saveSavings()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">L∆∞u</button>
          <button onclick="closePopup()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">H·ªßy</button>
        </div>
      </div>
    </div>

    <!-- T·ªïng l√£i ƒëang ch·∫°y -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold">üí∏ Ti·ªÅn L√£i ƒêang Ch·∫°y</h2>
      <p class="text-xl">T·ªïng l√£i: <span id="runningInterest" class="font-bold">0</span> VND</p>
    </div>

    <!-- N√∫t xu·∫•t nh·∫≠p CSV -->
    <div class="mb-6 flex space-x-4">
      <button onclick="downloadSampleCSV()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">T·∫£i File M·∫´u CSV</button>
      <label class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 cursor-pointer">
        Nh·∫≠p t·ª´ CSV
        <input type="file" id="importCSV" accept=".csv" class="hidden" onchange="importFromCSV(event)">
      </label>
      <button onclick="exportToCSV()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">Xu·∫•t ra CSV</button>
    </div>

    <!-- Danh s√°ch -->
    <div>
      <h2 class="text-lg font-semibold mb-2">üìò Danh S√°ch S·ªï Ti·∫øt Ki·ªám</h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse text-sm">
          <thead>
            <tr class="bg-gray-200">
              <th class="border p-2">T√™n TK</th>
              <th class="border p-2">S·ªë Ti·ªÅn</th>
              <th class="border p-2">Ng√¢n H√†ng</th>
              <th class="border p-2">Ng√†y G·ª≠i</th>
              <th class="border p-2">Ng√†y ƒê√°o H·∫°n</th>
              <th class="border p-2">K·ª≥ H·∫°n</th>
              <th class="border p-2">L√£i Su·∫•t</th>
              <th class="border p-2">L√£i Su·∫•t D·ª± Ki·∫øn</th>
              <th class="border p-2">T·ªïng G·ªëc + L√£i</th>
              <th class="border p-2">H√¨nh Th·ª©c L√£i</th>
              <th class="border p-2">Khi ƒê·∫øn H·∫°n</th>
              <th class="border p-2">H√†nh ƒê·ªông</th>
            </tr>
          </thead>
          <tbody id="savingsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let savings = JSON.parse(localStorage.getItem('savings')) || [];
    let accumulatedInterest = parseFloat(localStorage.getItem('accumulatedInterest')) || 0;
    let editingIndex = null;

    function saveToLocalStorage() {
      localStorage.setItem('savings', JSON.stringify(savings));
      localStorage.setItem('accumulatedInterest', accumulatedInterest);
    }

    function openPopup(index = null) {
      editingIndex = index;
      document.getElementById('popup').classList.remove('hidden');
      if (index !== null) {
        document.getElementById('popupTitle').textContent = 'Ch·ªânh s·ª≠a S·ªï Ti·∫øt Ki·ªám';
        const s = savings[index];
        document.getElementById('accountName').value = s.accountName;
        document.getElementById('amount').value = s.amount;
        document.getElementById('bank').value = s.bank;
        document.getElementById('startDate').value = s.startDate;
        document.getElementById('term').value = s.term;
        document.getElementById('interestRate').value = s.interestRate;
        document.getElementById('interestType').value = s.interestType;
        document.getElementById('renewalType').value = s.renewalType;
      } else {
        document.getElementById('popupTitle').textContent = 'Th√™m S·ªï Ti·∫øt Ki·ªám';
        clearForm();
      }
    }

    function closePopup() {
      document.getElementById('popup').classList.add('hidden');
      clearForm();
      editingIndex = null;
    }

    function clearForm() {
      ['accountName','amount','bank','startDate','term','interestRate','interestType','renewalType'].forEach(id => document.getElementById(id).value = '');
    }

    function saveSavings() {
      const data = {
        accountName: accountName.value,
        amount: parseFloat(amount.value),
        bank: bank.value,
        startDate: startDate.value,
        term: parseInt(term.value),
        interestRate: parseFloat(interestRate.value),
        interestType: interestType.value,
        renewalType: renewalType.value
      };
      if (Object.values(data).some(v => !v)) return alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
      if (editingIndex !== null) savings[editingIndex] = data; else savings.push(data);
      saveToLocalStorage();
      renderTable();
      updateRunningInterest();
      closePopup();
    }

    function deleteSavings(index) {
      if (confirm('X√≥a s·ªï ti·∫øt ki·ªám n√†y?')) {
        savings.splice(index, 1);
        saveToLocalStorage();
        renderTable();
        updateRunningInterest();
      }
    }

    function calculateMaturityDate(startDate, term) {
      const date = new Date(startDate);
      date.setMonth(date.getMonth() + term);
      return date.toISOString().split('T')[0];
    }

    function calculateInterest(amount, rate, months) {
      return amount * (rate / 100) * (months / 12);
    }

    function renderTable() {
      const tbody = document.getElementById('savingsTable');
      tbody.innerHTML = '';
      savings.forEach((s, i) => {
        const maturity = calculateMaturityDate(s.startDate, s.term);
        const interest = calculateInterest(s.amount, s.interestRate, s.term);
        const total = s.amount + interest;
        tbody.innerHTML += `
          <tr>
            <td class="border p-2">${s.accountName}</td>
            <td class="border p-2">${s.amount.toLocaleString()}</td>
            <td class="border p-2">${s.bank}</td>
            <td class="border p-2">${s.startDate}</td>
            <td class="border p-2">${maturity}</td>
            <td class="border p-2">${s.term}</td>
            <td class="border p-2">${s.interestRate}%</td>
            <td class="border p-2">${interest.toLocaleString()}</td>
            <td class="border p-2 font-semibold">${total.toLocaleString()}</td>
            <td class="border p-2">${s.interestType === 'start' ? 'ƒê·∫ßu k·ª≥' : 'Cu·ªëi k·ª≥'}</td>
            <td class="border p-2">${s.renewalType === 'principal' ? 'T√°i t·ª•c g·ªëc' : 'T√°i t·ª•c g·ªëc v√† l√£i'}</td>
            <td class="border p-2 space-x-2">
              <button onclick="openPopup(${i})" class="bg-yellow-400 text-white px-2 py-1 rounded">S·ª≠a</button>
              <button onclick="deleteSavings(${i})" class="bg-red-500 text-white px-2 py-1 rounded">X√≥a</button>
            </td>
          </tr>`;
      });
    }

    function calculateDailyInterest(amount, rate) {
      return amount * (rate / 100 / 365);
    }

    function updateRunningInterest() {
      const totalDaily = savings.reduce((sum, s) => sum + calculateDailyInterest(s.amount, s.interestRate), 0);
      const perSecond = totalDaily / (24 * 3600);
      clearInterval(window.interestInterval);
      window.interestInterval = setInterval(() => {
        accumulatedInterest += perSecond;
        document.getElementById('runningInterest').textContent = accumulatedInterest.toFixed(2);
        saveToLocalStorage();
      }, 1000);
    }

    // CSV Import/Export
    function downloadSampleCSV() {
      const rows = [
        ['accountName','amount','bank','startDate','term','interestRate','interestType','renewalType'],
        ['Nguyen Van A',10000000,'Vietcombank','2025-01-01',6,5.5,'end','principal']
      ];
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sample_savings.csv';
      a.click();
    }

    function importFromCSV(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = evt => {
        const lines = evt.target.result.split('\n').map(l => l.split(','));
        savings = [];
        for (let i = 1; i < lines.length; i++) {
          const [accountName, amount, bank, startDate, term, interestRate, interestType, renewalType] = lines[i];
          if (accountName && amount) savings.push({
            accountName, amount: parseFloat(amount), bank, startDate,
            term: parseInt(term), interestRate: parseFloat(interestRate),
            interestType, renewalType
          });
        }
        saveToLocalStorage();
        renderTable();
        updateRunningInterest();
      };
      reader.readAsText(file);
    }

    function exportToCSV() {
      const rows = [['accountName','amount','bank','startDate','term','interestRate','interestType','renewalType'],
        ...savings.map(s => [s.accountName, s.amount, s.bank, s.startDate, s.term, s.interestRate, s.interestType, s.renewalType])
      ];
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'savings_export.csv';
      a.click();
    }

    renderTable();
    updateRunningInterest();
  </script>
</body>
</html>
