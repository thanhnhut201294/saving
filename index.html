<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ Tiết Kiệm | Ultimate Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .card-glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(229, 231, 235, 0.5); }
        .hidden-value { filter: blur(5px); transition: all 0.3s; }
        .hidden-value:hover { filter: blur(0); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="auth-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center mx-4">
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i data-lucide="shield-check" class="w-8 h-8"></i>
            </div>
            <h1 class="text-2xl font-bold mb-2">Xác thực quyền truy cập</h1>
            <p class="text-slate-500 mb-6">Nhập mã bảo mật để xem báo cáo tài sản</p>
            <input type="password" id="pass-input" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none mb-4 text-center text-2xl tracking-widest" placeholder="******">
            <button onclick="unlock()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">Truy cập hệ thống</button>
            <p id="error-txt" class="text-red-500 text-sm mt-4 hidden">Mật khẩu không chính xác!</p>
        </div>
    </div>

    <div id="main-app" class="hidden opacity-0 transition-opacity duration-700">
        <nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight">FinanceTrack <span class="text-indigo-600">Pro</span></span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="togglePrivacy()" class="p-2 hover:bg-slate-100 rounded-full transition" title="Ẩn/Hiện số tiền">
                        <i data-lucide="eye" id="eye-icon" class="w-5 h-5"></i>
                    </button>
                    <button onclick="location.reload()" class="p-2 hover:bg-slate-100 rounded-full transition">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 text-white">
                <div class="bg-gradient-to-br from-indigo-600 to-indigo-700 p-6 rounded-3xl shadow-xl shadow-indigo-100">
                    <p class="opacity-80 text-sm font-medium mb-1 uppercase tracking-wider">Tổng vốn đang gửi</p>
                    <h2 id="stat-total" class="text-3xl font-bold money-val">0đ</h2>
                </div>
                <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-3xl shadow-xl shadow-emerald-100">
                    <p class="opacity-80 text-sm font-medium mb-1 uppercase tracking-wider">Lãi dự tính cuối kỳ</p>
                    <h2 id="stat-interest" class="text-3xl font-bold money-val">0đ</h2>
                </div>
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl shadow-xl shadow-slate-200">
                    <p class="opacity-80 text-sm font-medium mb-1 uppercase tracking-wider">Lãi suất TB năm</p>
                    <h2 id="stat-rate" class="text-3xl font-bold">0%</h2>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-3xl shadow-xl shadow-orange-100">
                    <p class="opacity-80 text-sm font-medium mb-1 uppercase tracking-wider">Đáo hạn < 30 ngày</p>
                    <h2 id="stat-upcoming" class="text-3xl font-bold">0 sổ</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div class="lg:col-span-1 card-glass p-6 rounded-3xl">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5 text-indigo-500"></i> Phân bổ Ngân hàng
                    </h3>
                    <canvas id="bankPieChart" height="250"></canvas>
                </div>
                <div class="lg:col-span-2 card-glass p-6 rounded-3xl">
                    <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-500"></i> Dòng tiền đáo hạn (Gốc + Lãi)
                    </h3>
                    <canvas id="cashflowBarChart" height="120"></canvas>
                </div>
            </div>

            <div class="card-glass rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/50">
                    <h3 class="font-bold text-slate-800">Danh sách sổ tiết kiệm chi tiết</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50/50 text-slate-500 text-xs uppercase tracking-widest font-semibold">
                                <th class="px-6 py-4">Tên tài khoản</th>
                                <th class="px-6 py-4">Ngân hàng</th>
                                <th class="px-6 py-4">Số tiền gửi</th>
                                <th class="px-6 py-4">Lãi suất</th>
                                <th class="px-6 py-4">Ngày đáo hạn</th>
                                <th class="px-6 py-4">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CONFIG = {
            CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_CDz1COjHWcwXRnQKrEpK-sfvGycbt7N4WsaJ71QUWzp2Dwg6sb3_zNVWq3Eq-3mJOa6_Wyj8eLO7/pub?output=csv',
            PASS: '062000'
        };

        let privacyMode = false;

        function unlock() {
            const input = document.getElementById('pass-input').value;
            if (input === CONFIG.PASS) {
                document.getElementById('auth-screen').style.display = 'none';
                const app = document.getElementById('main-app');
                app.classList.remove('hidden');
                setTimeout(() => app.classList.add('opacity-100'), 50);
                init();
            } else {
                document.getElementById('error-txt').classList.remove('hidden');
            }
        }

        function togglePrivacy() {
            privacyMode = !privacyMode;
            document.querySelectorAll('.money-val').forEach(el => {
                el.classList.toggle('hidden-value', privacyMode);
            });
            const icon = document.getElementById('eye-icon');
            icon.setAttribute('data-lucide', privacyMode ? 'eye-off' : 'eye');
            lucide.createIcons();
        }

        function formatCcy(val) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(val);
        }

        function parseDate(str) {
            const [d, m, y] = str.split('/');
            return new Date(y, m - 1, d);
        }

        async function init() {
            lucide.createIcons();
            Papa.parse(CONFIG.CSV_URL, {
                download: true,
                header: true,
                complete: (res) => render(res.data)
            });
        }

        function render(data) {
            let totals = { principal: 0, interest: 0, weightedRate: 0, upcoming: 0 };
            const banks = {}, cashflow = {}, tableBody = document.getElementById('data-table-body');
            const now = new Date();

            data.forEach(row => {
                if (!row['Tên tài khoản'] || row['Trạng thái'] !== 'Đang gửi') return;

                const principal = parseFloat(row['Số tiền gửi']);
                const rate = parseFloat(row['Lãi suất'].replace('%', '')) / 100;
                const months = parseInt(row['Kỳ hạn (tháng)']);
                const start = parseDate(row['Ngày gửi']);
                const end = new Date(start.setMonth(start.getMonth() + months));
                const interest = principal * rate * (months / 12);

                totals.principal += principal;
                totals.interest += interest;
                totals.weightedRate += (rate * principal);

                const daysLeft = Math.ceil((end - now) / (86400000));
                if (daysLeft >= 0 && daysLeft <= 30) totals.upcoming++;

                banks[row['Ngân hàng']] = (banks[row['Ngân hàng']] || 0) + principal;
                const mKey = `${end.getMonth() + 1}/${end.getFullYear()}`;
                cashflow[mKey] = (cashflow[mKey] || 0) + (principal + interest);

                const rowHtml = `
                    <tr class="hover:bg-slate-50 transition group">
                        <td class="px-6 py-4 font-semibold text-slate-700">${row['Tên tài khoản']}</td>
                        <td class="px-6 py-4"><span class="px-3 py-1 bg-slate-100 rounded-full text-xs font-medium text-slate-600">${row['Ngân hàng']}</span></td>
                        <td class="px-6 py-4 font-bold text-indigo-600 money-val">${formatCcy(principal)}</td>
                        <td class="px-6 py-4 text-emerald-600 font-semibold">${row['Lãi suất']}</td>
                        <td class="px-6 py-4 text-sm ${daysLeft <= 30 ? 'text-orange-600 font-bold' : 'text-slate-500'}">
                            ${end.toLocaleDateString('vi-VN')}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-1.5 text-xs font-bold text-emerald-500 uppercase italic">
                                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div> Active
                            </div>
                        </td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', rowHtml);
            });

            // Update Stats
            document.getElementById('stat-total').innerText = formatCcy(totals.principal);
            document.getElementById('stat-interest').innerText = formatCcy(totals.interest);
            document.getElementById('stat-rate').innerText = ((totals.weightedRate / totals.principal) * 100).toFixed(2) + '%';
            document.getElementById('stat-upcoming').innerText = totals.upcoming + ' sổ';

            // Charts
            new Chart(document.getElementById('bankPieChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(banks),
                    datasets: [{
                        data: Object.values(banks),
                        backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#6366F1', '#EC4899']
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
            });

            new Chart(document.getElementById('cashflowBarChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(cashflow),
                    datasets: [{ label: 'Vốn + Lãi thu về', data: Object.values(cashflow), backgroundColor: '#6366F1', borderRadius: 8 }]
                },
                options: { 
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
