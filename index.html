<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sổ Tiết Kiệm | Smart Finance Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Lexend', sans-serif; background-color: #f7fcf9; color: #1e3a2d; }
        .neumorphic {
            background: #f7fcf9;
            border-radius: 28px;
            box-shadow: 8px 8px 16px rgba(184, 196, 188, 0.2), -8px -8px 16px rgba(255, 255, 255, 0.8);
        }
        .neumorphic-inset {
            background: #e8f5ec;
            border-radius: 16px;
            box-shadow: inset 2px 2px 5px rgba(184, 196, 188, 0.3), inset -2px -2px 5px rgba(255, 255, 255, 0.7);
        }
        .val-blur { filter: blur(6px); transition: filter 0.3s ease-in-out; }
        .val-blur.show-value { filter: blur(0); }
        .progress-bar { height: 6px; border-radius: 9999px; background-color: #e0f2f7; overflow: hidden; }
        .progress-fill { height: 100%; background-color: #34d399; border-radius: 9999px; transition: width 0.5s ease-out; }
        .accent-green { color: #10b981; }
        .bg-accent-green-light { background-color: #e0fbf2; }

        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f7fcf9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #a7d9b9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #34d399; }
    </style>
</head>
<body class="bg-[#f7fcf9] text-[#1e3a2d] antialiased">

    <div id="auth-layer" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#f7fcf9]">
        <div class="neumorphic p-10 rounded-[2.5rem] w-full max-w-sm text-center mx-4">
            <div class="inline-flex p-4 bg-emerald-100 text-emerald-600 rounded-2xl mb-6">
                <i data-lucide="shield-check" class="w-10 h-10"></i>
            </div>
            <h1 class="text-3xl font-bold text-emerald-900 mb-2">Quản lý Tài chính</h1>
            <p class="text-slate-500 mb-8 italic">Vui lòng nhập mã bảo mật của bạn</p>
            <input type="password" id="entry-pass" class="w-full px-5 py-4 rounded-2xl border border-emerald-200 focus:border-emerald-500 outline-none mb-6 text-center text-3xl tracking-wider text-emerald-700" placeholder="••••••">
            <button onclick="handleLogin()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-emerald-700 transition-all active:scale-95 shadow-lg shadow-emerald-200">Truy cập Dashboard</button>
            <p id="auth-err" class="text-red-500 font-medium mt-4 hidden">Mã bảo mật không đúng!</p>
        </div>
    </div>

    <div id="dashboard" class="hidden opacity-0 transition-opacity duration-1000">
        <header class="sticky top-0 z-50 bg-[#f7fcf9]/80 backdrop-blur-md px-8 py-5 flex justify-between items-center border-b border-slate-100 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-emerald-600 rounded-xl flex items-center justify-center text-white shadow-md">
                    <i data-lucide="gem" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-tight text-emerald-900">WealthFlow</h1>
                    <div class="flex items-center gap-2 text-[11px] text-emerald-500 font-medium tracking-wide">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Dữ liệu trực tuyến
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-5">
                <button onclick="togglePrivacy()" class="p-2.5 rounded-full hover:bg-emerald-50 transition-colors text-slate-600">
                    <i data-lucide="eye" id="p-icon" class="w-6 h-6"></i>
                </button>
                <button onclick="location.reload()" class="flex items-center gap-2 bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold hover:bg-emerald-700 transition-all shadow-md shadow-emerald-200">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Cập nhật
                </button>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-8 py-10">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="neumorphic p-7 rounded-[2rem] flex flex-col justify-between h-40">
                    <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Tổng vốn hiện có</p>
                    <h2 id="total-principal" class="text-4xl font-extrabold text-emerald-900 val-blur">0đ</h2>
                </div>
                <div class="neumorphic p-7 rounded-[2rem] flex flex-col justify-between h-40">
                    <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Lãi đã phát sinh (Live)</p>
                    <h2 id="live-interest" class="text-4xl font-extrabold accent-green val-blur">0đ</h2>
                </div>
                <div class="neumorphic p-7 rounded-[2rem] flex flex-col justify-between h-40">
                    <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Lãi dự kiến cuối kỳ</p>
                    <h2 id="final-interest" class="text-4xl font-extrabold text-indigo-600 val-blur">0đ</h2>
                </div>
                <div class="neumorphic p-7 rounded-[2rem] flex flex-col justify-between h-40">
                    <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Đáo hạn < 30 ngày</p>
                    <h2 id="upcoming-count" class="text-4xl font-extrabold text-orange-600">0 sổ</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
                <div class="lg:col-span-1 neumorphic p-8 rounded-[2rem]">
                    <h3 class="font-bold text-slate-800 mb-8 text-xl flex items-center justify-between">
                        <span>Phân bổ theo Ngân hàng</span>
                        <i data-lucide="pie-chart" class="text-slate-300"></i>
                    </h3>
                    <div class="relative h-[280px]">
                        <canvas id="bankDistChart"></canvas>
                        <div id="portfolio-risk" class="absolute inset-0 flex items-center justify-center text-center font-bold text-sm"></div>
                    </div>
                </div>
                <div class="lg:col-span-2 neumorphic p-8 rounded-[2rem]">
                    <h3 class="font-bold text-slate-800 mb-8 text-xl flex items-center justify-between">
                        <span>Dự báo dòng tiền Lãi về theo tháng</span>
                        <i data-lucide="bar-chart-2" class="text-slate-300"></i>
                    </h3>
                    <div class="h-[280px]">
                        <canvas id="interestCashflowChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-10">
                <div class="neumorphic p-7 rounded-[2rem] lg:col-span-1 xl:col-span-1 flex flex-col justify-between">
                    <div>
                        <h3 class="font-bold text-slate-800 mb-5 text-xl flex items-center gap-2">
                            <i data-lucide="line-chart" class="w-5 h-5 text-emerald-600"></i>
                            Dự báo & Phân tích
                        </h3>
                        <div class="grid grid-cols-2 gap-y-4 text-sm">
                            <p class="col-span-2 text-slate-500 mb-2 font-semibold">Tài sản dự kiến:</p>
                            <p class="text-slate-600">Cuối 2025:</p>
                            <p id="forecast-2025" class="font-bold text-emerald-600 val-blur text-right">0đ</p>
                            <p class="text-slate-600">Cuối 2026:</p>
                            <p id="forecast-2026" class="font-bold text-emerald-600 val-blur text-right">0đ</p>
                            <p class="col-span-2 text-slate-500 mt-4 mb-2 font-semibold">Hiệu suất danh mục:</p>
                            <p class="text-slate-600">Lãi suất TB:</p>
                            <p id="avg-rate" class="font-bold text-emerald-600 text-right">0%</p>
                            <p class="text-slate-600">Lãi/ngày (TB):</p>
                            <p id="avg-daily-interest" class="font-bold text-emerald-600 val-blur text-right">0đ</p>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 xl:col-span-2 neumorphic p-7 rounded-[2rem]">
                    <h3 class="font-bold text-slate-800 mb-8 text-xl flex items-center justify-between">
                        <span>Danh sách Sổ tiết kiệm</span>
                        <i data-lucide="credit-card" class="text-slate-300"></i>
                    </h3>
                    <div id="savings-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[600px] overflow-y-auto pr-2">
                        </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CONFIG = {
            CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_CDz1COjHWcwXRnQKrEpK-sfvGycbt7N4WsaJ71QUWzp2Dwg6sb3_zNVWq3Eq-3mJOa6_Wyj8eLO7/pub?output=csv',
            ACCESS_PASS: '062000',
            RISK_THRESHOLD: 0.6 // Cảnh báo nếu một ngân hàng chiếm > 60% tổng vốn
        };

        let isPrivate = false;
        let allSavingsData = []; // To store parsed CSV data
        let liveInterestInterval; // For live interest update

        // Utility functions
        function formatVND(value) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }

        function parseDate(dateString) {
            const [day, month, year] = dateString.split('/');
            return new Date(year, month - 1, day);
        }

        function addMonths(date, months) {
            const d = new Date(date);
            d.setMonth(d.getMonth() + months);
            return d;
        }

        // Authentication & Privacy
        function handleLogin() {
            if (document.getElementById('entry-pass').value === CONFIG.ACCESS_PASS) {
                document.getElementById('auth-layer').style.display = 'none';
                document.getElementById('dashboard').classList.remove('hidden');
                setTimeout(() => document.getElementById('dashboard').classList.add('opacity-100'), 100);
                initDashboard();
            } else {
                document.getElementById('auth-err').classList.remove('hidden');
            }
        }

        function togglePrivacy() {
            isPrivate = !isPrivate;
            document.querySelectorAll('.val-blur').forEach(el => {
                el.classList.toggle('show-value', !isPrivate);
            });
            document.getElementById('p-icon').setAttribute('data-lucide', isPrivate ? 'eye-off' : 'eye');
            lucide.createIcons();
        }

        // Core Dashboard Logic
        async function initDashboard() {
            lucide.createIcons(); // Initialize Lucide Icons
            Papa.parse(CONFIG.CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    allSavingsData = results.data.filter(row => row['Trạng thái'] === 'Đang gửi' && row['Số tiền gửi'] && parseFloat(row['Số tiền gửi']) > 0);
                    renderDashboard(allSavingsData);
                    liveInterestInterval = setInterval(updateLiveInterest, 1000); // Update live interest every second
                },
                error: (error) => {
                    console.error("Error parsing CSV:", error);
                    alert("Không thể tải dữ liệu. Vui lòng kiểm tra kết nối hoặc link CSV.");
                }
            });
        }

        function renderDashboard(data) {
            let totalPrincipal = 0;
            let totalFinalInterest = 0;
            let weightedAvgRate = 0;
            let upcomingMaturities = 0;
            let bankDistribution = {}; // For pie chart
            let interestCashflow = {}; // For bar chart (interest only)

            const now = new Date();
            const cardsContainer = document.getElementById('savings-cards-container');
            cardsContainer.innerHTML = ''; // Clear previous cards

            // Initialize cashflow for next 12 months
            for (let i = 0; i < 12; i++) {
                const date = addMonths(now, i);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                interestCashflow[monthYear] = 0;
            }

            data.forEach(row => {
                const principal = parseFloat(row['Số tiền gửi']);
                const rate = parseFloat(row['Lãi suất'].replace('%', '')) / 100;
                const termMonths = parseInt(row['Kỳ hạn (tháng)']);
                const startDate = parseDate(row['Ngày gửi']);
                const maturityDate = addMonths(startDate, termMonths);

                const interestPerTerm = principal * rate * (termMonths / 12);
                
                totalPrincipal += principal;
                totalFinalInterest += interestPerTerm;
                weightedAvgRate += (principal * rate);

                // Check upcoming maturities
                const daysToMaturity = Math.ceil((maturityDate - now) / (1000 * 60 * 60 * 24));
                if (daysToMaturity > 0 && daysToMaturity <= 30) {
                    upcomingMaturities++;
                }

                // Bank Distribution
                bankDistribution[row['Ngân hàng']] = (bankDistribution[row['Ngân hàng']] || 0) + principal;

                // Interest Cashflow for next 12 months (only if maturity is within this range)
                const maturityMonthYear = `${maturityDate.getMonth() + 1}/${maturityDate.getFullYear()}`;
                if (interestCashflow.hasOwnProperty(maturityMonthYear)) {
                    interestCashflow[maturityMonthYear] += interestPerTerm;
                }

                // Render Card for each saving account
                const progressDays = Math.max(0, Math.min(daysToMaturity, termMonths * 30.4375)); // Approx days in month
                const totalTermDays = (termMonths / 12) * 365;
                const percentageCompleted = (totalTermDays > 0) ? Math.max(0, Math.min(100, ((totalTermDays - daysToMaturity) / totalTermDays) * 100)) : 0;

                let statusText = '';
                let statusColor = 'text-slate-500';
                if (daysToMaturity <= 0) {
                    statusText = 'Đã đáo hạn';
                    statusColor = 'text-red-500 font-bold';
                } else if (daysToMaturity <= 30) {
                    statusText = `Còn ${daysToMaturity} ngày`;
                    statusColor = 'text-orange-500 font-bold animate-pulse';
                } else if (daysToMaturity > 30) {
                    const monthsLeft = Math.floor(daysToMaturity / 30.4375);
                    const remainingDays = Math.ceil(daysToMaturity % 30.4375);
                    statusText = `Còn ${monthsLeft} tháng ${remainingDays} ngày`;
                    statusColor = 'text-emerald-600';
                }

                const cardHtml = `
                    <div class="neumorphic p-6 rounded-3xl relative overflow-hidden h-56 flex flex-col justify-between">
                        <div class="absolute right-[-10px] top-[-10px] opacity-[0.03] scale-125">
                             <i data-lucide="banknote" class="w-32 h-32 text-emerald-900"></i>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="font-bold text-lg text-emerald-900">${row['Tên tài khoản']}</div>
                                <span class="bg-accent-green-light text-emerald-700 px-3 py-1 rounded-full text-xs font-semibold">${row['Ngân hàng']}</span>
                            </div>
                            <h4 class="text-3xl font-extrabold text-emerald-600 val-blur">${formatVND(principal)}</h4>
                        </div>
                        <div>
                            <div class="flex items-center justify-between text-sm mb-2">
                                <span class="text-slate-500">Lãi suất: <span class="font-semibold text-slate-700">${row['Lãi suất']}</span></span>
                                <span class="${statusColor}">${statusText}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentageCompleted}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                cardsContainer.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Update main stats
            document.getElementById('total-principal').innerText = formatVND(totalPrincipal);
            document.getElementById('final-interest').innerText = formatVND(totalFinalInterest);
            document.getElementById('upcoming-count').innerText = upcomingMaturities + ' sổ';
            document.getElementById('avg-rate').innerText = ((weightedAvgRate / totalPrincipal) * 100).toFixed(2) + '%';
            document.getElementById('avg-daily-interest').innerText = formatVND(totalFinalInterest / 365);


            // Risk Analysis
            const topBank = Object.entries(bankDistribution).sort((a,b) => b[1]-a[1])[0];
            const riskRatio = topBank && totalPrincipal > 0 ? (topBank[1] / totalPrincipal) : 0;
            const portfolioRiskEl = document.getElementById('portfolio-risk');
            if (riskRatio > CONFIG.RISK_THRESHOLD) {
                portfolioRiskEl.innerHTML = `<span class="text-red-500">Rủi ro cao<br>(${topBank[0]} > ${Math.round(riskRatio * 100)}%)</span>`;
            } else if (totalPrincipal === 0) {
                 portfolioRiskEl.innerHTML = `<span class="text-slate-400">Chưa có dữ liệu</span>`;
            }
             else {
                portfolioRiskEl.innerHTML = `<span class="text-emerald-600">Danh mục đa dạng<br>(An toàn)</span>`;
            }

            // Forecast for 2025 and 2026
            const forecast2025 = calculateYearEndForecast(data, 2025, totalPrincipal);
            const forecast2026 = calculateYearEndForecast(data, 2026, totalPrincipal);
            document.getElementById('forecast-2025').innerText = formatVND(forecast2025);
            document.getElementById('forecast-2026').innerText = formatVND(forecast2026);


            renderCharts(bankDistribution, interestCashflow);
        }

        // Calculate forecast for specific year
        function calculateYearEndForecast(data, targetYear, initialPrincipal) {
            let total = initialPrincipal;
            data.forEach(row => {
                const principal = parseFloat(row['Số tiền gửi']);
                const rate = parseFloat(row['Lãi suất'].replace('%', '')) / 100;
                const termMonths = parseInt(row['Kỳ hạn (tháng)']);
                const startDate = parseDate(row['Ngày gửi']);
                let maturityDate = addMonths(startDate, termMonths);

                // Simple annual growth assumption: Reinvest all principal and interest
                // This is a simplified model, actual compound interest calculation is more complex
                if (maturityDate.getFullYear() <= targetYear) {
                    const interest = principal * rate * (termMonths / 12);
                    // Add back to total if it's the principal being managed
                    // Simplified: just assuming interest contributes to the pool
                }
            });
            // A more accurate forecast needs to track each principal with its maturity and assumed reinvestment rate
            // For now, let's just make a simple projection based on average growth
            const yearsToForecast = targetYear - new Date().getFullYear();
            if (yearsToForecast < 0) return total;
            
            // Simplified growth rate based on average portfolio rate
            const averagePortfolioRate = (parseFloat(document.getElementById('avg-rate').innerText.replace('%', '')) / 100) || 0.05; // Default 5%
            return initialPrincipal * Math.pow((1 + averagePortfolioRate), yearsToForecast);
        }


        function updateLiveInterest() {
            let currentLiveInterest = 0;
            const now = new Date();

            allSavingsData.forEach(row => {
                const principal = parseFloat(row['Số tiền gửi']);
                const rate = parseFloat(row['Lãi suất'].replace('%', '')) / 100;
                const startDate = parseDate(row['Ngày gửi']);

                const timeSinceStartMs = now - startDate;
                if (timeSinceStartMs > 0) {
                    // Calculate interest accrued per second: Principal * Annual Rate * (Seconds passed / Seconds in a year)
                    const secondsInYear = 365 * 24 * 60 * 60;
                    currentLiveInterest += principal * rate * (timeSinceStartMs / (secondsInYear * 1000));
                }
            });
            document.getElementById('live-interest').innerText = formatVND(currentLiveInterest);
        }

        let bankChartInstance, cashflowChartInstance; // Store chart instances to destroy/update

        function renderCharts(bankData, cashflowData) {
            const chartColors = ['#10b981', '#6366f1', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#3b82f6', '#06b6d4'];

            // Destroy existing charts if they exist
            if (bankChartInstance) bankChartInstance.destroy();
            if (cashflowChartInstance) cashflowChartInstance.destroy();

            // Bank Distribution Chart
            bankChartInstance = new Chart(document.getElementById('bankDistChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(bankData),
                    datasets: [{
                        data: Object.values(bankData),
                        backgroundColor: chartColors,
                        borderColor: '#f7fcf9', // Background color to make slices distinct
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: { 
                    cutout: '70%', 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                usePointStyle: true, 
                                font: { weight: '600', size: 12 }, 
                                color: '#4b5563', 
                                padding: 25 
                            } 
                        } 
                    } 
                }
            });

            // Interest Cashflow Chart
            cashflowChartInstance = new Chart(document.getElementById('interestCashflowChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(cashflowData),
                    datasets: [{
                        label: 'Lãi nhận về',
                        data: Object.values(cashflowData),
                        backgroundColor: '#34d399', // Emerald green for interest
                        borderRadius: 8,
                        barThickness: 20
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { display: false }, 
                            ticks: { 
                                callback: function(value) { return value / 1000000 + ' Tr'; }, // Format to Tr VND
                                color: '#6b7280', font: { size: 11 } 
                            }, 
                            border: { display: false } 
                        },
                        x: { 
                            grid: { display: false }, 
                            border: { display: false }, 
                            ticks: { 
                                color: '#6b7280', font: { weight: '600', size: 11 } 
                            } 
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>

