<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sổ Tiết Kiệm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #login-overlay {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-80 text-center">
            <i data-lucide="lock" class="mx-auto mb-4 text-indigo-600"></i>
            <h2 class="text-xl font-bold mb-4 text-gray-800">Nhập mật khẩu</h2>
            <input type="password" id="password-input" class="w-full p-2 border rounded-lg mb-4 text-center focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="******">
            <button onclick="checkPassword()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">Truy cập</button>
            <p id="error-msg" class="text-red-500 text-sm mt-2 hidden">Sai mật khẩu!</p>
        </div>
    </div>

    <div id="main-content" class="hidden container mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="wallet" class="text-indigo-600"></i> Dashboard Tiết Kiệm
            </h1>
            <div class="text-sm text-gray-500 italic">Dữ liệu tự động cập nhật từ Google Sheets</div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-morphism p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                <p class="text-sm text-gray-500">Tổng vốn gửi</p>
                <h3 id="total-principal" class="text-2xl font-bold text-gray-800">0đ</h3>
            </div>
            <div class="glass-morphism p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                <p class="text-sm text-gray-500">Lãi dự tính (cuối kỳ)</p>
                <h3 id="total-interest" class="text-2xl font-bold text-green-600">0đ</h3>
            </div>
            <div class="glass-morphism p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                <p class="text-sm text-gray-500">Lãi suất TB</p>
                <h3 id="avg-rate" class="text-2xl font-bold text-gray-800">0%</h3>
            </div>
            <div class="glass-morphism p-6 rounded-xl shadow-sm border-l-4 border-yellow-500">
                <p class="text-sm text-gray-500">Sổ sắp đến hạn</p>
                <h3 id="upcoming-count" class="text-2xl font-bold text-gray-800">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-semibold mb-4 text-gray-700">Phân bổ theo Ngân hàng</h3>
                <canvas id="bankChart" height="200"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-semibold mb-4 text-gray-700">Dòng tiền đáo hạn theo tháng</h3>
                <canvas id="monthChart" height="200"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-semibold text-gray-700">Chi tiết các sổ đang gửi</h3>
                <div id="status-filter" class="flex gap-2"></div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-600 text-sm uppercase">
                        <tr>
                            <th class="p-4">Tên sổ</th>
                            <th class="p-4">Ngân hàng</th>
                            <th class="p-4 text-right">Số tiền gửi</th>
                            <th class="p-4">Lãi suất</th>
                            <th class="p-4">Ngày gửi</th>
                            <th class="p-4">Ngày đáo hạn</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_CDz1COjHWcwXRnQKrEpK-sfvGycbt7N4WsaJ71QUWzp2Dwg6sb3_zNVWq3Eq-3mJOa6_Wyj8eLO7/pub?output=csv';
        const APP_PASS = '062000';

        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if (input === APP_PASS) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                initData();
            } else {
                document.getElementById('error-msg').classList.remove('hidden');
            }
        }

        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function parseDate(dateStr) {
            const parts = dateStr.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function addMonths(date, months) {
            let d = new Date(date);
            d.setMonth(d.getMonth() + parseInt(months));
            return d;
        }

        async function initData() {
            lucide.createIcons();
            
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    processData(results.data);
                }
            });
        }

        function processData(data) {
            let totalPrincipal = 0;
            let totalInterest = 0;
            let totalRateWeight = 0;
            let upcoming = 0;
            const bankCounts = {};
            const monthlyCashflow = {};
            const tableBody = document.getElementById('table-body');
            const now = new Date();

            data.forEach(row => {
                if (!row['Tên tài khoản'] || row['Trạng thái'] !== 'Đang gửi') return;

                const principal = parseFloat(row['Số tiền gửi']);
                const rate = parseFloat(row['Lãi suất'].replace('%', '')) / 100;
                const months = parseInt(row['Kỳ hạn (tháng)']);
                const startDate = parseDate(row['Ngày gửi']);
                const endDate = addMonths(startDate, months);
                
                // Tính toán tổng quan
                totalPrincipal += principal;
                const interest = principal * rate * (months / 12);
                totalInterest += interest;
                totalRateWeight += (rate * principal);
                
                // Kiểm tra sổ sắp đến hạn (trong 30 ngày)
                const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                if (daysLeft >= 0 && daysLeft <= 30) upcoming++;

                // Gom nhóm biểu đồ
                bankCounts[row['Ngân hàng']] = (bankCounts[row['Ngân hàng']] || 0) + principal;
                const monthKey = `${endDate.getMonth() + 1}/${endDate.getFullYear()}`;
                monthlyCashflow[monthKey] = (monthlyCashflow[monthKey] || 0) + principal + interest;

                // Render Table
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="p-4 font-medium text-gray-800">${row['Tên tài khoản']}</td>
                    <td class="p-4 text-gray-600">${row['Ngân hàng']}</td>
                    <td class="p-4 text-right font-semibold">${formatVND(principal)}</td>
                    <td class="p-4"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs font-bold">${row['Lãi suất']}</span></td>
                    <td class="p-4 text-gray-500 text-sm">${row['Ngày gửi']}</td>
                    <td class="p-4">
                        <span class="${daysLeft <= 30 ? 'text-orange-600 font-bold' : 'text-gray-500'} text-sm">
                            ${endDate.toLocaleDateString('vi-VN')}
                        </span>
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            // Hiển thị tổng quan
            document.getElementById('total-principal').innerText = formatVND(totalPrincipal);
            document.getElementById('total-interest').innerText = formatVND(totalInterest);
            document.getElementById('avg-rate').innerText = ((totalRateWeight / totalPrincipal) * 100).toFixed(2) + '%';
            document.getElementById('upcoming-count').innerText = upcoming;

            // Vẽ biểu đồ tròn
            new Chart(document.getElementById('bankChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(bankCounts),
                    datasets: [{
                        data: Object.values(bankCounts),
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });

            // Vẽ biểu đồ cột dòng tiền
            new Chart(document.getElementById('monthChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyCashflow),
                    datasets: [{
                        label: 'Số tiền về (Gốc + Lãi)',
                        data: Object.values(monthlyCashflow),
                        backgroundColor: '#6366f1'
                    }]
                }
            });
        }
    </script>
</body>
</html>
